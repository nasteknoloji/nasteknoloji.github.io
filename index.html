
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>NAS Borsa Piyasa Fiyat Verileri</title>
  <script src="https://cdn.socket.io/4.4.0/socket.io.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .price-up { background-color: #dcfce7; color: #15803d; }
    .price-down { background-color: #fee2e2; color: #b91c1c; }
    tbody tr:hover { background-color: #f1f5f9; }
    tbody tr:nth-child(even) { background-color: #f9fafb; }
    table { border-collapse: collapse; }
    th, td { border-bottom: 1px solid #283038; }
  </style>
</head>
<body class="bg-black text-gray-900">
  <div class="container mx-auto p-4">
    

    <div class="mb-4 flex flex-wrap justify-center gap-2">
      <button id="tab-currency" class="px-4 py-2 bg-blue-500 text-white rounded">Para Birimleri</button>
      <button id="tab-metal" class="px-4 py-2 bg-blue-500 text-white rounded">Madenler</button>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full bg-white rounded shadow">
        <thead class="bg-blue-100">
          <tr class="text-sm font-semibold">
            <th class="py-3 px-4 text-left">Kısaltma</th>
            <th class="py-3 px-4 text-left">Açıklama</th>
            <th class="py-3 px-4 text-right">Alış</th>
            <th class="py-3 px-4 text-right">Satış</th>
            <th class="py-3 px-4 text-right">Tarih</th>
          </tr>
        </thead>
        <tbody id="data-body" class="text-sm">
          <tr><td colspan="5" class="text-center py-4">Veri bekleniyor...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
const fullNames = {
  GUMUSUSD: "Gümüş / ABD Doları",
  USDTRY: "ABD Doları / TL",
  EURTRY: "Euro / TL",
  GBPTRY: "İngiliz Sterlini / TL",
  CHFTRY: "İsviçre Frangı / TL",
  AUDTRY: "Avustralya Doları / TL",
  CADTRY: "Kanada Doları / TL",
  SARTRY: "Suudi Riyali / TL",
  NOKTRY: "Norveç Kronu / TL",
  DKKTRY: "Danimarka Kronu / TL",
  SEKTRY: "İsveç Kronu / TL",
  JPYTRY: "Japon Yeni / TL",
  USDCHF: "ABD Doları / İsviçre Frangı",
  USDJPY: "ABD Doları / Japon Yeni",
  USDCAD: "ABD Doları / Kanada Doları",
  EURUSD: "Euro / ABD Doları",
  GBPUSD: "İngiliz Sterlini / ABD Doları",
  AUDUSD: "Avustralya Doları / ABD Doları",
  USDSAR: "ABD Doları / Suudi Riyali",
  ALTIN: "Gram Altın",
  AYAR22: "22 Ayar Altın",
  AYAR14: "14 Ayar Altın",
  GUMUSTRY: "Gram Gümüş",
  CEYREK_YENI: "Yeni Çeyrek Altın",
  CEYREK_ESKI: "Eski Çeyrek Altın",
  YARIM_YENI: "Yeni Yarım Altın",
  YARIM_ESKI: "Eski Yarım Altın",
  ONS: "Altın Ons",
  ATA_YENI: "Ata Altın Yeni",
  ATA_ESKI: "Ata Altın Eski",
  ATA5_YENI: "5'li Ata Altın Yeni",
  ATA5_ESKI: "5'li Ata Altın Eski",
  GREMESE_YENI: "Gremse Altın Yeni",
  GREMESE_ESKI: "Gremse Altın Eski",
  TEK_YENI: "Tam Altın Yeni",
  TEK_ESKI: "Tam Altın Eski",  XAGUSD: "Gümüş / Dolar",
  XAUUSD: "Altın / Dolar",
  PLATIN: "Platin Gram",
  XPTUSD: "Platin / Dolar",
  XPDUSD: "Paladyum / Dolar",
  PALADYUM: "Paladyum TL",
  EURKG: "Euro / Kg",
  USDKG: "Dolar / Kg",
  USDPURE: "Dolar Saf Altın",
  XAUXAG: "Altın / Gümüş Oranı"
};

const metalKeys = [
  // Altın grubu
  "ALTIN", "AYAR22", "AYAR14", "CEYREK_YENI", "CEYREK_ESKI", "YARIM_YENI", "YARIM_ESKI", "ONS",
  "ATA_YENI", "ATA_ESKI", "ATA5_YENI", "ATA5_ESKI", "GREMESE_YENI", "GREMESE_ESKI", "TEK_YENI", "TEK_ESKI",  // Gümüş grubu
  "GUMUSTRY", "GUMUSUSD", "XAGUSD",
  // Diğer değerli metaller
  "XAUUSD", "PLATIN", "XPTUSD", "XPDUSD", "PALADYUM", "EURKG", "USDKG", "USDPURE", "XAUXAG"
];

let latestData = new Map();
let lastValues = new Map();
let selectedTab = 'currency';

function formatNumber(value) {
  const num = parseFloat(value);
  return isNaN(num) ? '-' : num.toFixed(4);
}

function formatTime(raw) {
  if (!raw) return '-';
  const parts = raw.split(' ');
  const date = parts[0].split('-').reverse().join('/');
  return `${date} ${parts[1]}`;
}

const socket = io("wss://api.haremaltin.com", {
  transports: ["websocket"],
  forceNew: true,
  timeout: 10000,
  rejectUnauthorized: false
});

socket.on("connect", () => console.log("✅ Bağlandı"));
socket.on("disconnect", () => console.warn("❌ Bağlantı kesildi"));

socket.on("price_changed", (response) => {
  if (!response || !response.data) return;
  const data = response.data;
  const time = formatTime(response.meta?.tarih);

  for (const [key, value] of Object.entries(data)) {
    const alis = parseFloat(value.alis ?? value.buy ?? value.price);
    const satis = parseFloat(value.satis ?? value.sell ?? value.satis_fiyati);
    if (isNaN(alis) || isNaN(satis)) continue;

    const prev = lastValues.get(key);
    const direction = prev ? (satis > prev ? 'up' : satis < prev ? 'down' : '') : '';
    lastValues.set(key, satis);
    if (key !== 'KULCEALTIN') latestData.set(key, { alis, satis, time, direction });
  }
  renderTable();
});

function renderTable() {
  const tbody = document.getElementById("data-body");
  tbody.innerHTML = "";
  for (const [key, val] of latestData.entries()) {
    const isMetal = metalKeys.includes(key);
    if ((selectedTab === 'currency' && isMetal) || (selectedTab === 'metal' && !isMetal)) continue;

    const row = document.createElement("tr");
    const name = fullNames[key] || '-';
    row.className = val.direction === 'up' ? 'price-up' : val.direction === 'down' ? 'price-down' : '';
    row.innerHTML = `
      <td class="py-2 px-4 font-medium">${key}</td>
      <td class="py-2 px-4">${name}</td>
      <td class="py-2 px-4 text-right">${formatNumber(val.alis)}</td>
      <td class="py-2 px-4 text-right">${formatNumber(val.satis)}</td>
      <td class="py-2 px-4 text-right">${val.time}</td>
    `;
    tbody.appendChild(row);
  }
}

document.getElementById('tab-currency').addEventListener('click', () => {
  selectedTab = 'currency';
  renderTable();
});

document.getElementById('tab-metal').addEventListener('click', () => {
  selectedTab = 'metal';
  renderTable();
});
</script>
  <p class="text-center text-sm text-gray-500 mt-8">
    Bu sayfada yer alan fiyatlar yalnızca bilgilendirme amaçlıdır, herhangi bir bağlayıcılığı yoktur.
  </p>
</body>
</html>
